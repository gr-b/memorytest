<html>
<head>
<!-- Visual Working Memory Test by Griffin Bishop -->
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="coinrowlogic.js"></script>
<style type="text/css">
	#locator { position: absolute; visibility: visible; left: 20px; top: 300px; height: 100px; width: 150px; z-index: 200; }
</style>
</head>
<body style="background-color: #003366">
	
	<nav id="upper_nav" class="navbar navbar-inverse">
		<div class="container-fluid">
					<ul class="nav nav-pills">
						<p class="navbar-brand">Coin Row Problem</p>
						<li><input type="text" class="form-control .col-lg-*" id="vector"></li>
						<li><a id="randbutton">Randomize</a></li>
						<li><a id="stepButton">Step</a></li>
						<li><a id="autoButton">Auto</a></li>
					</ul>
		</div>
	</nav>
	
	<div id="locator">
	<p>hello</p>
	</div>

	
	<canvas id="canvas" width="500" height="500">
	</canvas>
	<script>
	var LOWER_BOUND = 0;
	var UPPER_BOUND = 10;
	var NUM_ELTS = 25;
	
	var GRAPH_COLOR = "#0066ff";
	var GRAPH_COLOR = '#BFFFF1';
	var COIN_COLOR = '#7CFFCB';
	var BGCOLOR = "#003366";
	var TEXTCOLOR = "#66ff33";
	var FONT = "Helvetica";
	var LINE_COLOR = "#74F2CE";
	
	var GRAPH_PERCENT_FROM_EDGES = 0.05;
	
	// Initialize these variables.
	var graph_height = 0;
	var graph_width = 0;
	
	var graph_min_y = 0;
	var graph_max_y = 0;
	
	var graph_min_x = 0;
	var graph_max_x = 0;
	
	var graph;
	//// End init vars ////
	
	var coin_array = [];
	var solved_coins = [];
	var solved_indices = [];
	var most_down = 0;

	
	var choice1, choice1ind, choice2, choice2ind;
	var choiceIndex = 0;
	
	// Canvas initialization
	var canvas = document.getElementById("canvas");
	canvas.height = window.innerHeight;
	canvas.width = window.innerWidth;
	
	var ctx = canvas.getContext("2d");
	initCanvas();
	calcGraphLocations();
	drawOutline();
	randomize();
	drawGraph();
	
	$(document).ready(function(){
		
		$("#randbutton").click(function(){
		    randomize();
		});
		
		$("#stepButton").click(function(){
			coin_array = getNumsEntered();
			if(coin_array){
				clear();
				drawGraph();
				coinStep();
				//setNumsEntered(coin_array);
			}
		});
	
		$( window ).resize(function(){
			initCanvas();
			calcGraphLocations();
			drawOutline();
			drawGraph();
			drawSolvedCoins();
			drawIndividualSolved();
			if(solved_coins.length<coin_array.length+1){
					drawChoices(choice1, choice2, choiceIndex);
			}
		});
	});
	
	function randomize(){
		coin_array = randArray(NUM_ELTS, LOWER_BOUND, UPPER_BOUND);
		var randstring = coin_array.join(" ");
		$("#vector").val(randstring);
		solved_coins = [];
		solved_indices = [];
		most_down = 0;
	}
	
	function coinStep(){
			if(solved_coins.length>coin_array.length+1){
				drawIndividualSolved();
				drawSolvedCoins();
				return;
			}
			if(!(solved_coins.length > 0)){
				solved_coins = [ [0], [coin_array[0]] ];
				solved_indices = [[0], [0]];
				drawChoices([0],[coin_array[0]],0);
			} else {
				var i = solved_coins.length-1;
				choiceIndex = i;
				choice1 = [coin_array[i]].concat(solved_coins[i-1]);
				choice1ind = [i].concat(solved_indices[i-1]);
				choice2 = solved_coins[i];
				choice2ind = solved_indices[i];
				//console.log(solved_coins);
				if(solved_coins.length<coin_array.length+1){
					drawChoices(choice1, choice2, i);
				}
				solved_coins.push(getBestChoice(choice1, choice2, choice1ind, choice2ind));
				drawSolvedCoins();
				drawIndividualSolved();
			}
	}
	
	function drawIndividualSolved(){
		for(var i=0;i<solved_coins.length;i++){
			if(i-1>coin_array.length){
				break;
			}
			if(i<2){
				continue;
			}
			var coins = solved_coins[i-1];
			coins = removeZeros(coins);
			if(most_down < coins.length){
				most_down = coins.length;
			}
			var coinWidth = getCoinSize()/most_down;
			
			var x = getCoinX(i-2);//(i-2)*getCoinSize();//getCoinX(i-2);
			
			for(var j=0;j<coins.length;j++){
				if(coins[j]>0){
					drawCoin(coins[j], x+j*coinWidth, graph.min_y+getCoinSize()*3, 
							coinWidth, COIN_COLOR);
				}
			}
		}
	}
	
	function drawChoice2(choice, num, index){
		choice = removeZeros(choice);
		var coinWidth = getCoinSize()/choice.length;
			
		var y = graph.min_y+getCoinSize()*(3+num);
			
		for(var i=0;i<choice.length;i++){
				var val = choice[i];
				var x = getCoinX(index);//graph.min_x + (index)*getCoinSize();
				if (val>0){
					drawCoin(val, x+i*coinWidth, y, coinWidth, COIN_COLOR);
				}
		}
	}
	
	function removeZeros(arr){
		var newArr = [];
		for(var i=0;i<arr.length;i++){
				if(arr[i] != 0){
						newArr.push(arr[i]);
				}
		}
		return newArr;
	}
	
	function drawSolvedCoins(){
			var coins = solved_coins[solved_coins.length-2];
			var solved = solved_indices[solved_indices.length-2];
			for(var i=0;i<coins.length;i++){
					if(coins[i]>0){
						drawCoin(coins[i], getCoinX(solved[i]), graph.min_y+getCoinSize(), getCoinSize(), COIN_COLOR);
					}
			}
	}
	
	// Draws the two choices out for that index.
	function drawChoices(choice1, choice2, index){
		var x = getCoinX(index);
		// Draw first one:
		var y = graph.min_y + getCoinSize()*4;
		//drawChoice(choice1, x, y);
		//drawChoice(choice2, x+getCoinSize()/2, y);
		drawChoice2(choice1, 1, index);
		drawChoice2(choice2, 2, index);
	}
	
	function drawChoice(choice, x, y){
		for(var i=0;i<choice.length;i++){
				var val = choice[i];
				if (val>0){
					drawCoin(val, x, y+i*getCoinSize()/2,  getCoinSize()/2,COIN_COLOR);
				}
		}
	}
	
	// Returns the array whose elements sum to the largest value
	function getBestChoice(first, second, choice1ind, choice2ind){
			if (sumArray(first) > sumArray(second)){
				solved_indices.push(choice1ind);
				return first;
			} else {
				solved_indices.push(choice2ind);
				return second;
			}
	}
	
	// Sums the elements in an array
	function sumArray(arr){
			var sum = 0;
			for(var i=0;i<arr.length;i++){
					sum += arr[i];
			}
			return sum;
	}
	
	
	// Draws the current graph on the screen.
	function drawGraph(){
		var coinSize = getCoinSize();
		for(var i=0;i<coin_array.length;i++){
			drawCoin(coin_array[i], getCoinX(i), graph.min_y, coinSize, COIN_COLOR);
		}
	}
	
	// Draws a bar surrounding the coins of the given indices in coin_array.
	function drawBar(start, end){
		var coinSize = getCoinSize();
		var startX = getCoinX(start);
		var endX = getCoinX(end) + coinSize;
		var y = graph.min_y + coinSize;
		
		ctx.lineWidth = 10;
		ctx.strokeStyle = LINE_COLOR;
		ctx.beginPath();
		ctx.moveTo(startX, y);
		ctx.lineTo(endX, y);
		ctx.stroke();
	}
	
	// Gets the size of a coin in the main coin list.
	function getCoinSize(){
		var dim = Math.min(graph.width, graph.height);
		coinSize = Math.floor(dim/(coin_array.length));
		return coinSize;
	}
	
	// Gets the x position of the coin in coin_array in the main coin list.
	function getCoinX(index){
		var colSize = Math.floor(graph.width/(coin_array.length));
		return graph.min_x+index*colSize;
	}
	
	// Draws a coin with equal width and height at the coordinates specified and the size specified.
	function drawCoin(value, x, y, size, color){
			drawCircle(x, y, size, color);
			
			var fontSize = Math.floor((0.75)*size);
			ctx.font = fontSize + "px " + FONT;
			ctx.fillStyle = '#13a8a4';
			
			var fontX = centerText(value, x+size/2);
			var fontY = y+((size/2) + fontSize/3);
			 
			ctx.fillText(value, fontX, fontY);
	}
	
	function drawCircle(x, y, size, color){
			var rad = size/2;
			var centerX = Math.round(x+rad);
			var centerY = Math.round(y+rad);
			
			ctx.lineWidth = 10;
			ctx.strokeStyle = "black";
			ctx.beginPath();
			ctx.arc(centerX, centerY, rad, 0, 2* Math.PI, true);
			ctx.closePath();
			ctx.stroke();
			ctx.fillStyle = color;
			ctx.fill();
			// Now draw the outline
	}
	
	// Gets the array of numbers entered
	function getNumsEntered(){
			var vectorText = $("#vector").val();
			if(!(/^\d+$/.test(vectorText.replace(/\s+/g, '')))){ alert("String must only contain digits"); return;}
			// Make sure its only numbers.
			var vector = vectorText.split(" ");
			for (var i=0;i<vector.length;i++){
					vector[i] = parseInt(vector[i]);
			}
			return vector;
	}
	
	// Sets the entered nums box to the array given
	function setNumsEntered(arr){
		var arrString = arr.join(" ");
		$("#vector").val(arrString);
	}
	
	// Draws the canvas background and inital text
	function initCanvas(){
			canvas.height = window.innerHeight - document.getElementById("upper_nav").clientHeight;
			canvas.width = window.innerWidth;
			ctx.fillStyle = BGCOLOR;
			ctx.fillRect(0, 0, canvas.width, canvas.height);
	}
	function clear() {
	ctx.clearRect(0,0,canvas.width,canvas.height);
	}
	</script>
</body>
</html>
