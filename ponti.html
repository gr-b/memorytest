<!DOCTYPE html>

<html>

<head>

	<script type="text/javascript" src="d3.min.js"></script>

</head>

<body>

</body>

<script type="text/javascript" src="ponti.json"></script>
<script type="text/javascript">

var legendPointRadius = 5;
var dataPointRadius = 5;

for(var i=0; i<ponti.length;i++){
	//console.log(ponti[i])
	ponti[i]["id"] = i;
}

function getWindowSize(){
	// Taken from https://stackoverflow.com/questions/3437786/get-the-size-of-the-screen-current-web-page-and-browser-window
	var w = window,
    	d = document,
    	e = d.documentElement,
    	g = d.getElementsByTagName('body')[0],
    	
	size = {};
	size.x = w.innerWidth || e.clientWidth || g.clientWidth,
    	size.y = w.innerHeight|| e.clientHeight|| g.clientHeight;
	return size;
}

function toArray(object){
	arr = [];
	for(var key in object){
		if(object.hasOwnProperty(key)){
			arr.push([key, object[key]]);
		}
	}
	return arr;
}

function removeSVGs(){
	var elements = document.getElementsByTagName("svg");
	for(var i = elements.length - 1; i >=0; i--){
		elements[i].parentNode.removeChild(elements[i]);
	}
}

function getRandomColor() {
  var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

var heading = d3.select("body").append("h1");

var select = d3.select("body").append("select")
	.attr("onChange", "draw()");
select.selectAll("option")
	.data(toArray(ponti[0]))
	.enter()
	.append("option")
	.attr("value", function(d){return d[0]})
	.text(function(d){return d[0]});

function getSelectedAttribute(){
	var selector = document.getElementsByTagName("select")[0];
	var selectedAttribute = selector.options[selector.selectedIndex].text;
	//console.log(selectedAttribute);
	return selectedAttribute;
}

function refreshHeading(){
	heading.text(getSelectedAttribute());
}

refreshHeading();


function openTooltip(cid){
	var circle = document.getElementsByTagName("circle")[cid];
	var x = circle.getAttribute("cx");
	var y = circle.getAttribute("cy");
	var category = ponti[cid][getSelectedAttribute()];
	console.log(category);
	var gs = d3.select("svg").selectAll("g")
		.data([{"x": x, "y": y}])
		.enter()
		.append("g")
		.attr("transform", function(d){
			return "translate("+x+","+y+")";
		});
	gs.append("rect")
		.attr("width", 0)
		.attr("height", 0)
		.attr("style", "fill:red");
	gs.append("text")
		.text(category)
		.attr("transform", "translate(-20,-10)");
	
}

function closeTooltip(){
	draw();
};


var xMultiplier = 930;
var yMultiplier = 1250;
var xOffset = -20;
var yOffset = 270;

document.onkeypress = function (e) {
	e = e || window.event;
	console.log(e.keyCode);
	if (e.keyCode == 105){ // i
		yOffset = yOffset - 10;	
	} else if(e.keyCode == 107) { // k;
		yOffset = yOffset + 10;
	} else if(e.keyCode == 106) { //j
		xOffset = xOffset - 10;
	} else if(e.keyCode == 108) { // l
		xOffset = xOffset + 10;
	} else if(e.keyCode == 115) { // s key
		console.log("a key");
		yMultiplier = yMultiplier - 10;
	} else if(e.keyCode == 119) { // w key
		yMultiplier = yMultiplier + 10;
	} else if(e.keyCode == 100) { // D key
		xMultiplier = xMultiplier + 10;
	} else if(e.keyCode == 97) { // a key
		xMultiplier = xMultiplier - 10;
	}
	draw();
	console.log("Ymult: "+ yMultiplier + " |  X mult: " + xMultiplier + "xoff:" + xOffset + "|yoff:" + yOffset);
}






function draw() {

var svgWidth = 600;
var svgHeight = 390;


refreshHeading();
var selectedAttribute = getSelectedAttribute();

removeSVGs();

var svgContainer = d3.select("body").append("svg")
	.attr("width", svgWidth)
	.attr("height", svgHeight)
	.attr("display", "block")
	.style("border", "1px solid black");


// Add venice image
svgContainer.append("image")
	.attr("xlink:href", "https://i.pinimg.com/736x/e5/c0/d7/e5c0d75f80bb7ca18fa9726b0c3fe779--italy-map-grand-canal.jpg")
	//.attr("xlink:href", "https://i.imgur.com/rK8eOsi.gif")
	.attr("x", 0)
	.attr("y", 0)
	.attr("width", 600)
	.attr("height", 450);
	//.attr("transform", "skewX(10) skewY(10)");
////////


var circles = svgContainer.selectAll("circle")
	.data(ponti)
	.enter()
	.append("circle");

var convertLat = function (d) {
	var lat = parseFloat(d['lat']);	
	var lat = lat * 10;
	return lat;
};

//var selectedAttribute = 'Material of Summit Pavement';

// Legend creation
var legend = {};
//var colors = ["red","green","blue", "lime", "fuchsia", "purple", "silver", "yellow", "aqua"]
var colors = ["aqua","silver","purple","yellow","fuchsia","lime","blue","green","red"];

for(var i=0; i<ponti.length;i++){
	var bridge = ponti[i];
	var selectedCategory = bridge[selectedAttribute];
	if (!(selectedCategory in legend)) {
		legend[selectedCategory] = 1;
	} else {
		legend[selectedCategory] = legend[selectedCategory] + 1;
	}
}
var sortable = [];
for(var category in legend){
	sortable.push([category, legend[category]]);
}
sortable.sort(function(a, b) {
	return b[1] - a[1];
});

var legend = {};
for (var i in sortable){
	var pair = sortable[i];
	if (colors.length > 0) {
		legend[pair[0]] = colors.pop();
	} else {
		legend[pair[0]] = getRandomColor();
	}
}
// End legend creation

var circle_id = 0;

var circleAttributes = circles
	.attr("cx", function (d) {
		var temp = (10 * parseFloat(d['lng']))-123;
		return temp*xMultiplier + xOffset;
	})
	.attr("cy", function (d) {
		var temp = (10 * parseFloat(d['lat']))-454;
		var ypos = svgHeight - (temp*yMultiplier) + yOffset;
		return ypos;
	})
	.attr("r", dataPointRadius)
	.style("fill", function(d) {
		var material = d[selectedAttribute];
		var color = legend[material];
		//console.log("Material: " + material + " | Color: " + color);
		return color;
	})
	.attr("opacity", function (d) {
		return 0.5; 
	})
	.attr("id", function(d){
		var id = circle_id;
		circle_id++;
		return id;
	})
	.attr("onmouseover", function(d){
		return "openTooltip("+d["id"]+")";
	})
	.attr("onmouseout", "closeTooltip()");

/*for(var category in legend){
	if(legend.hasOwnProperty(category)){
		console.log(category + ": " + legend[category])
	}
}*/

var currentY = 0;
var iterableLegend = [];
for(var category in legend){
	currentY = currentY + 10;
	var color = legend[category];
	if(category == ""){
		category = "No Data Available";
	}
	iterableLegend.push({'category': category, 'color': color,'y': currentY});
}

/*var legendContainer = d3.select("body")
	.selectAll("div")
	.data(iterableLegend)
	.enter()
	.append("div")
	.text(function(d){
		//console.log(d);
		return d;
	});
*/	

var height = iterableLegend.length * 20 + 20;

var legendSVG = d3.select("body").append("svg")
	.attr("width", 400)
	.attr("height", height)
	.attr("display", "block")
	.style("border", "1px solid black");

var legendCircles = legendSVG.selectAll("g")
	.data(iterableLegend)
	.enter()
	.append("g")
	.attr("transform", function (d){ return "translate(10,"+d.y+")"});

var legendCircleAttributes = legendCircles.append("circle")
	.attr("cx", function (d) {
		return 10;
	})
	.attr("cy", function (d) {
		currentY = d.y;
		//console.log(currentY);		
		return currentY;
	})
	.attr("r", legendPointRadius)
	.style("fill", function(d) {
		return d.color;
	})
	.attr("opacity", function (d) {
		return 0.5; 
	});

legendCircles.append("text")
	.attr("x", 20)
	.attr("y", function(d){return d.y + 5})
	.text(function (d){return d.category});
}

draw();

</script>
</html>
